<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FC Hybrid Analyst</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    <style>
        :root {
            --bg-darker: #0d1117;
            --bg-dark: #161b22;
            --bg-med: #21262d;
            --accent-primary: #3b82f6;
            --profit-color: #2ea043;
            --loss-color: #da3633;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-darker);
            color: #c9d1d9;
            overflow-x: hidden;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 200%; height: 200%; z-index: -1;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px; animation: bg-pan 120s linear infinite;
        }
        @keyframes bg-pan { 0% { transform: translate(0, 0); } 100% { transform: translate(-50%, -50%); } }

        .deal-card {
            background: linear-gradient(145deg, var(--bg-dark), #0d1117);
            border: 1px solid var(--bg-med);
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            display: flex; flex-direction: column; overflow: hidden;
            position: relative;
        }
        .deal-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.6);
            border-color: var(--accent-primary);
        }
        .deal-card.highlight-profit { border: 1px solid var(--profit-color); box-shadow: 0 0 15px rgba(46, 160, 67, 0.2); }

        .tab-panel { display: none; }
        .tab-panel.active { display: grid; }
        
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        .animate-pop { animation: popIn 0.3s ease-out forwards; }

        .custom-input { background-color: var(--bg-dark); border: 1px solid var(--bg-med); color: white; transition: border-color 0.2s; }
        .custom-input:focus { border-color: var(--accent-primary); outline: none; }
        
        .nav-select { 
            background-color: #161b22; border: 1px solid #21262d; color: white; 
            padding: 0.5rem 1rem; border-radius: 0.5rem; width: 100%; max-width: 220px; 
            cursor: pointer; transition: all 0.2s; font-weight: 600;
        }
        .nav-select:hover, .nav-select:focus { border-color: var(--accent-primary); }

        #tax-calc { transition: transform 0.3s ease; }
        #tax-calc.minimized { transform: translateY(calc(100% - 40px)); }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
        
        /* Toast */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background-color: #2ea043; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: slideUp 0.3s ease-out forwards; pointer-events: auto; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="sticky top-0 z-50 bg-[#0d1117]/95 backdrop-blur-md border-b border-[var(--bg-med)]">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl sm:text-2xl font-bold text-white tracking-widest uppercase flex items-center gap-2">
                <span class="text-blue-500">FC</span> FLIPS
            </h1>
            <div class="flex items-center gap-3 bg-[var(--bg-dark)] px-3 py-1.5 rounded border border-[var(--bg-med)]">
                <div id="status-indicator" class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                <span id="status-text" class="text-xs font-medium text-gray-400">Connecting...</span>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 mt-6">
        <div class="flex flex-col sm:flex-row justify-center items-center gap-6 border-b border-[var(--bg-med)] pb-6">
            <div class="text-center sm:text-left w-full sm:w-auto flex flex-col items-center sm:items-start">
                <label class="block text-xs text-gray-500 uppercase mb-1 font-bold tracking-wider">Trading</label>
                <select id="nav-trading" class="nav-select">
                    <option value="" disabled>Select Trading...</option>
                    <option value="sell_zone" selected>Flux Flips</option>
                    <option value="average">Below Avg Flips</option>
                    <option value="median">Median Flips</option>
                    <option value="price_drop">Price Drop Flips</option>
                </select>
            </div>
            <div class="hidden sm:block w-px h-10 bg-gray-800"></div>
            <div class="text-center sm:text-left w-full sm:w-auto flex flex-col items-center sm:items-start">
                <label class="block text-xs text-gray-500 uppercase mb-1 font-bold tracking-wider">Tools</label>
                <select id="nav-tools" class="nav-select text-white">
                    <option value="" disabled selected>Select Tool...</option>
                    <option value="price_checker">Price Checker</option>
                    <option value="trade_tracker">Trade Tracker</option>
                </select>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 flex flex-col gap-6 flex-grow relative">
        
        <div id="trading-views">
            <div class="bg-[var(--bg-dark)] p-5 rounded-xl border border-[var(--bg-med)] shadow-lg mb-6">
                <div class="flex flex-wrap justify-between items-end mb-4 gap-4">
                    <div>
                        <h2 class="text-lg font-semibold text-white">Filters</h2>
                        <p id="last-updated" class="text-xs text-gray-500">Live Data</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs uppercase text-gray-500 font-bold">Highlight Profit ></span>
                        <input type="text" id="highlight-threshold" class="custom-input w-24 px-2 py-1 rounded text-sm" placeholder="10,000">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <input type="text" id="filter-name" class="custom-input w-full rounded p-2 text-sm" placeholder="Search Player...">
                    <input type="text" id="filter-min-profit" class="custom-input w-full rounded p-2 text-sm" placeholder="Min Profit (e.g. 4,000)">
                    <input type="text" id="filter-max-price" class="custom-input w-full rounded p-2 text-sm" placeholder="Max Price (e.g. 200,000)">
                    <select id="filter-sort" class="custom-input w-full rounded p-2 text-sm cursor-pointer">
                        <option value="newest">ðŸ•’ Newest First</option>
                        <option value="profit">ðŸ’° Highest Profit</option>
                        <option value="drop">ðŸ“‰ Biggest Drop %</option>
                    </select>
                </div>
                <div id="dynamic-filters" class="mt-4 pt-4 border-t border-[var(--bg-med)] empty:hidden"></div>
            </div>

            <div id="sell_zone-panel" class="tab-panel active grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            <div id="average-panel" class="tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            <div id="median-panel" class="tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            <div id="price_drop-panel" class="tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            
            <div id="no-deals" class="hidden py-24 flex flex-col items-center justify-center text-gray-500">
                <div class="mb-4 p-4 bg-[var(--bg-dark)] rounded-full border border-[var(--bg-med)]">
                    <svg class="w-12 h-12 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <p class="text-xl font-medium text-white">No Deals Found</p>
            </div>
        </div>

        <div id="price_checker-panel" class="tab-panel">
            <div class="max-w-3xl mx-auto">
                <div class="bg-[var(--bg-dark)] p-6 rounded-xl border border-[var(--bg-med)] mb-6">
                    <h2 class="text-xl font-bold text-white mb-4">Player Price Checker</h2>
                    <div class="relative">
                        <input type="text" id="checker-search" class="custom-input w-full p-3 rounded text-lg" placeholder="Type player name to search active database...">
                        <div id="checker-results" class="mt-4 space-y-2"></div>
                    </div>
                </div>
                <div id="checker-card-view" class="hidden flex justify-center"></div>
            </div>
        </div>

        <div id="trade_tracker-panel" class="tab-panel">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="bg-[var(--bg-dark)] p-5 rounded-xl border border-[var(--bg-med)] sticky top-24">
                        <h3 class="font-bold text-white mb-4">Add Transaction</h3>
                        <form id="trade-form" class="space-y-3">
                            <input type="text" id="trade-name" class="custom-input w-full p-2 rounded" placeholder="Player Name" required>
                            <input type="text" id="trade-buy" class="custom-input w-full p-2 rounded" placeholder="Buy Price" required>
                            <input type="number" id="trade-qty" class="custom-input w-full p-2 rounded" placeholder="Quantity" value="1">
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded transition-colors">Add to Trades</button>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-[var(--bg-dark)] p-5 rounded-xl border border-[var(--bg-med)]">
                        <h3 class="font-bold text-white mb-4 flex justify-between">
                            Active Trades <span id="active-count" class="text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded">0</span>
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-400">
                                <thead class="text-xs text-gray-200 uppercase bg-[var(--bg-med)]">
                                    <tr>
                                        <th class="px-4 py-2">Player</th><th class="px-4 py-2">Buy</th><th class="px-4 py-2">Qty</th><th class="px-4 py-2">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="active-trades-body"></tbody>
                            </table>
                        </div>
                        <div id="no-active-trades" class="text-center py-4 text-gray-600">No active trades.</div>
                    </div>

                    <div class="bg-[var(--bg-dark)] p-5 rounded-xl border border-[var(--bg-med)]">
                        <h3 class="font-bold text-white mb-4 flex justify-between">
                            Sold History <span id="total-profit-display" class="text-sm font-mono text-green-400">TP: 0</span>
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-400">
                                <thead class="text-xs text-gray-200 uppercase bg-[var(--bg-med)]">
                                    <tr>
                                        <th class="px-4 py-2">Player</th><th class="px-4 py-2">Buy</th><th class="px-4 py-2">Sell</th><th class="px-4 py-2">Profit</th><th class="px-4 py-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="history-trades-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <div id="sell-modal" class="hidden fixed inset-0 z-[60] modal-backdrop flex items-center justify-center p-4">
        <div class="bg-[#161b22] border border-[#21262d] p-6 rounded-xl w-full max-w-sm shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4">Complete Sale</h3>
            <p id="modal-player-name" class="text-sm text-gray-400 mb-4">Selling Player</p>
            <label class="text-xs uppercase text-gray-500 font-bold">Sold For</label>
            <input type="text" id="modal-sell-price" class="custom-input w-full p-3 rounded mt-1 mb-6 text-lg font-mono" placeholder="e.g. 50,000">
            <div class="flex gap-3">
                <button id="modal-cancel" class="flex-1 py-2 rounded border border-gray-600 text-gray-300 hover:bg-gray-800 transition">Cancel</button>
                <button id="modal-confirm" class="flex-1 py-2 rounded bg-green-600 text-white font-bold hover:bg-green-500 transition">Confirm</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 z-[70] modal-backdrop flex items-center justify-center p-4">
        <div class="bg-[#161b22] border border-[#21262d] p-6 rounded-xl w-full max-w-sm shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-2">Confirm Deletion</h3>
            <p class="text-sm text-gray-400 mb-6">Permanently remove this trade?</p>
            <div class="flex gap-3">
                <button id="confirm-cancel" class="flex-1 py-2 rounded border border-gray-600 text-gray-300 hover:bg-gray-800 transition">Cancel</button>
                <button id="confirm-ok" class="flex-1 py-2 rounded bg-red-600 text-white font-bold hover:bg-red-500 transition">Delete</button>
            </div>
        </div>
    </div>

    <div id="tax-calc" class="fixed bottom-4 right-4 w-64 bg-[var(--bg-dark)] border border-[var(--accent-primary)] rounded-lg shadow-2xl z-50 overflow-hidden minimized">
        <div id="tax-header" class="bg-[var(--accent-primary)] px-4 py-2 text-white font-bold text-sm flex justify-between items-center cursor-pointer">
            <span>EA Tax Calc</span><span>_</span>
        </div>
        <div class="p-4 space-y-3">
            <input type="text" id="calc-buy" class="custom-input w-full p-1 text-sm rounded" placeholder="Buy">
            <input type="text" id="calc-sell" class="custom-input w-full p-1 text-sm rounded" placeholder="Sell">
            <div class="pt-2 border-t border-gray-700 flex justify-between items-center">
                <span class="text-xs font-bold text-gray-300">Profit:</span>
                <span id="calc-result" class="text-lg font-bold text-white">0</span>
            </div>
        </div>
    </div>

    <template id="deal-card-template">
        <div class="deal-card group h-full">
            <a data-id="link" href="#" target="_blank" class="flex flex-col h-full">
                <div class="bg-gradient-to-b from-[#1f2937] to-[var(--bg-dark)] p-6 relative flex justify-center border-b border-[var(--bg-med)]">
                    <img data-id="image" src="" class="w-36 h-36 object-contain transition-transform duration-300 group-hover:scale-110 drop-shadow-2xl" alt="Player">
                    <div class="add-tracker-btn absolute bottom-2 right-2 bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-full shadow-lg cursor-pointer opacity-0 group-hover:opacity-100 transition-all z-20">
                        <svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    </div>
                </div>
                <div class="p-4 flex-grow flex flex-col gap-3 bg-[var(--bg-dark)]">
                    <h3 data-id="name" class="text-center text-lg font-bold text-white truncate mb-1">Player</h3>
                    
                    <div class="grid grid-cols-2 gap-2 text-center">
                        <div class="bg-[var(--bg-med)] p-2 rounded border border-gray-800">
                            <div class="text-[10px] text-gray-400 uppercase">Current</div>
                            <div data-id="current-price" class="text-lg font-bold text-white">0</div>
                        </div>
                        <div class="bg-[var(--bg-med)] p-2 rounded border border-gray-800">
                            <div data-id="target-label" class="text-[10px] text-gray-400 uppercase">Target</div>
                            <div data-id="target-price" class="text-lg font-bold text-blue-400">0</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-y-3 gap-x-2 text-sm mt-2 border-b border-[var(--bg-med)] pb-3">
                        <div class="text-center">
                            <span class="text-gray-500 text-[10px] uppercase block">24h Low</span>
                            <span data-id="low-24h" class="font-bold text-red-400 text-sm">-</span>
                        </div>
                        <div class="text-center">
                            <span class="text-gray-500 text-[10px] uppercase block">6h Avg</span>
                            <span data-id="avg-6h" class="font-bold text-gray-300 text-sm">0</span>
                        </div>
                        <div class="text-center">
                            <span class="text-gray-500 text-[10px] uppercase block">Drop</span>
                            <span data-id="drop" class="font-bold text-red-400 text-sm">0%</span>
                        </div>
                        <div class="text-center">
                            <span class="text-gray-500 text-[10px] uppercase block">Stability</span>
                            <span data-id="cv" class="font-bold text-gray-300 text-sm">-</span>
                        </div>
                    </div>

                    <div class="mt-auto pt-2 flex justify-between items-center">
                         <span class="text-xs font-bold text-gray-500 uppercase">Profit</span>
                         <span data-id="profit" class="text-2xl font-bold text-[var(--profit-color)] drop-shadow-sm">0</span>
                    </div>
                </div>
                <div data-id="time" class="text-[10px] text-center text-gray-600 py-1 border-t border-[var(--bg-med)] bg-[#0d1117]">00:00</div>
            </a>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDyNZGfhc0lJi14TJzlRDngFUFY47LCoBk",
            authDomain: "snipes-31c9e.firebaseapp.com",
            databaseURL: "https://snipes-31c9e-default-rtdb.firebaseio.com",
            projectId: "snipes-31c9e",
            storageBucket: "snipes-31c9e.firebasestorage.app",
            messagingSenderId: "617023725696",
            appId: "1:617023725696:web:0fc9f269a10417950c8665",
            measurementId: "G-5KN0CY3R7F"
        };

        const state = {
            deals: {},
            allPlayers: {},
            trades: JSON.parse(localStorage.getItem('fc_trades')) || [],
            history: JSON.parse(localStorage.getItem('fc_trade_history')) || [],
            activeTab: "sell_zone",
            filters: { name: "", minProfit: 0, maxPrice: 0, sort: "newest", highlight: 0, medianCount: 10 },
            sellModalId: null,
            deleteAction: null
        };

        const MAX_AGE_MS = 30 * 60 * 1000;

        const els = {
            grid: {
                sell_zone: document.getElementById('sell_zone-panel'),
                average: document.getElementById('average-panel'),
                median: document.getElementById('median-panel'),
                price_drop: document.getElementById('price_drop-panel')
            },
            tradingView: document.getElementById('trading-views'),
            checkerPanel: document.getElementById('price_checker-panel'),
            trackerPanel: document.getElementById('trade_tracker-panel'),
            noDeals: document.getElementById('no-deals'),
            navTrading: document.getElementById('nav-trading'),
            navTools: document.getElementById('nav-tools'),
            dynFilters: document.getElementById('dynamic-filters'),
            inputs: {
                search: document.getElementById('filter-name'),
                profit: document.getElementById('filter-min-profit'),
                price: document.getElementById('filter-max-price'),
                sort: document.getElementById('filter-sort'),
                highlight: document.getElementById('highlight-threshold')
            },
            modal: document.getElementById('sell-modal'),
            modalInput: document.getElementById('modal-sell-price'),
            modalName: document.getElementById('modal-player-name'),
            modalConfirm: document.getElementById('modal-confirm'),
            modalCancel: document.getElementById('modal-cancel'),
            confModal: document.getElementById('confirm-modal'),
            confOk: document.getElementById('confirm-ok'),
            confCancel: document.getElementById('confirm-cancel'),
            toastContainer: document.getElementById('toast-container')
        };

        // Rounding
        function roundPrice(price) {
            if (!price || price <= 0) return 0;
            if (price <= 50000) return Math.round(price / 250) * 250;
            if (price <= 100000) return Math.round(price / 500) * 500;
            return Math.round(price / 1000) * 1000;
        }
        const formatNum = n => n ? roundPrice(n).toLocaleString() : '0';
        const cleanNum = s => parseFloat(s.toString().replace(/,/g, '')) || 0;

        function addCommas(input) {
            const val = input.value.replace(/,/g, '').replace(/\D/g, '');
            if (val) input.value = parseInt(val).toLocaleString();
        }
        document.querySelectorAll('input[type="text"]').forEach(inp => {
            if(inp.id.includes('profit') || inp.id.includes('price') || inp.id.includes('buy') || inp.id.includes('sell') || inp.id.includes('threshold')) {
                inp.addEventListener('input', () => addCommas(inp));
            }
        });

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = msg;
            els.toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function renderDynamicFilters() {
            els.dynFilters.innerHTML = '';
            if (state.activeTab === 'median') {
                els.dynFilters.innerHTML = `
                    <div class="flex items-center gap-4">
                        <span class="text-xs text-gray-500 uppercase">Basis:</span>
                        <div class="flex gap-2">
                            ${[3, 5, 10, 15].map(n => `<label class="flex items-center gap-1 text-xs text-gray-400 cursor-pointer"><input type="radio" name="medC" value="${n}" ${state.filters.medianCount === n ? 'checked' : ''}> Last ${n}</label>`).join('')}
                        </div>
                    </div>`;
                els.dynFilters.querySelectorAll('input').forEach(i => i.addEventListener('change', (e) => {
                    state.filters.medianCount = parseInt(e.target.value); render();
                }));
            }
        }

        function createCard(deal) {
            const tmpl = document.getElementById('deal-card-template');
            const clone = tmpl.content.cloneNode(true);
            const card = clone.querySelector('.deal-card');

            if (state.filters.highlight > 0 && deal.profit >= state.filters.highlight) {
                card.classList.add('highlight-profit');
            }

            clone.querySelector('[data-id="name"]').textContent = deal.name;
            const img = clone.querySelector('[data-id="image"]');
            img.src = deal.image;
            img.onerror = () => img.src = "https://fut.gg/assets/img/players/default.png";
            clone.querySelector('[data-id="link"]').href = deal.link;

            clone.querySelector('[data-id="current-price"]').textContent = formatNum(deal.currentPrice);
            clone.querySelector('[data-id="drop"]').textContent = `-${Math.abs(deal.dropPerc).toFixed(1)}%`;
            
            // Populate 2x2 Grid
            const low24h = clone.querySelector('[data-id="low-24h"]');
            low24h.textContent = deal.low_24h ? formatNum(deal.low_24h) : '-';
            
            const avg6h = clone.querySelector('[data-id="avg-6h"]');
            avg6h.textContent = formatNum(deal.avg_6h);

            const cv = clone.querySelector('[data-id="cv"]');
            cv.textContent = deal.cv ? `${(deal.cv*100).toFixed(1)}%` : '-';
            if(deal.cv <= 0.075) cv.className = "font-bold text-green-400 text-sm";
            else if(deal.cv <= 0.12) cv.className = "font-bold text-blue-400 text-sm";
            else cv.className = "font-bold text-gray-300 text-sm";

            let targetPrice = deal.targetPrice;
            let label = "Target";

            if(state.activeTab === 'average') { label = "12h Avg"; }
            else if(state.activeTab === 'sell_zone') { label = "Sell Zone"; }
            else if(state.activeTab === 'median') {
                label = `Median`;
                const medKey = `med${state.filters.medianCount}`;
                if(deal[medKey]) targetPrice = deal[medKey];
            }
            else if(state.activeTab === 'price_drop') { label = "Prev Price"; }

            const profit = Math.round(targetPrice * 0.95 - deal.currentPrice);

            clone.querySelector('[data-id="target-label"]').textContent = label;
            clone.querySelector('[data-id="target-price"]').textContent = formatNum(targetPrice);
            clone.querySelector('[data-id="profit"]').textContent = formatNum(profit);
            
            clone.querySelector('[data-id="time"]').textContent = new Date(deal.timestamp).toLocaleTimeString();

            clone.querySelector('.add-tracker-btn').addEventListener('click', (e) => {
                e.preventDefault(); e.stopPropagation();
                addToPortfolio(deal.name, deal.currentPrice);
                showToast(`${deal.name} added to Trades`);
            });

            return { card: clone, profit: profit }; 
        }

        function render() {
            const isTrading = !['price_checker', 'trade_tracker'].includes(state.activeTab);
            els.tradingView.style.display = isTrading ? 'block' : 'none';
            els.checkerPanel.style.display = state.activeTab === 'price_checker' ? 'block' : 'none';
            els.trackerPanel.style.display = state.activeTab === 'trade_tracker' ? 'block' : 'none';

            if(!isTrading) return;

            Object.values(els.grid).forEach(g => g.innerHTML = '');
            let count = 0;
            const now = Date.now();
            let dealsArr = Object.values(state.deals);

            dealsArr = dealsArr.filter(d => {
                if (d.type !== state.activeTab) return false;
                if (now - d.timestamp > MAX_AGE_MS) return false;
                if (state.filters.search && !d.name.toLowerCase().includes(state.filters.search.toLowerCase())) return false;
                if (state.filters.minPrice && d.currentPrice < state.filters.minPrice) return false;
                if (state.filters.maxPrice && d.currentPrice > state.filters.maxPrice) return false;
                return true;
            }).sort((a, b) => {
                if(state.filters.sort === 'profit') return b.profit - a.profit;
                if(state.filters.sort === 'drop') return b.dropPerc - a.dropPerc;
                return b.timestamp - a.timestamp;
            });

            const targetGrid = els.grid[state.activeTab];
            if (targetGrid) {
                dealsArr.forEach(deal => {
                    const obj = createCard(deal);
                    if(state.filters.minProfit && obj.profit < state.filters.minProfit) return;
                    targetGrid.appendChild(obj.card);
                    count++;
                });
            }

            els.noDeals.classList.toggle('hidden', count > 0);
        }

        // --- AUTO REFRESH ---
        setInterval(() => { if(state.deals) render(); }, 15000);

        els.navTrading.addEventListener('change', (e) => {
            state.activeTab = e.target.value;
            els.navTools.selectedIndex = 0; 
            renderDynamicFilters(); render();
        });
        els.navTools.addEventListener('change', (e) => {
            state.activeTab = e.target.value;
            els.navTrading.selectedIndex = 0;
            render();
        });

        // --- PRICE CHECKER ---
        document.getElementById('checker-search').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const resDiv = document.getElementById('checker-results');
            resDiv.innerHTML = '';
            if(val.length < 2) return;

            const matches = Object.values(state.allPlayers).filter(d => d.name.toLowerCase().includes(val));
            const unique = Array.from(new Map(matches.map(item => [item.id, item])).values());

            unique.forEach(p => {
                const div = document.createElement('div');
                div.className = "bg-[#21262d] p-4 rounded cursor-pointer hover:bg-[#30363d] flex flex-col gap-2 border border-gray-700 relative group";
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex gap-3 items-center">
                             <img src="${p.image}" class="w-24 h-24 object-contain">
                             <div class="font-bold text-white text-lg leading-tight">${p.name}</div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-right">
                                 <div class="text-xs text-gray-400 uppercase">Current Price</div>
                                 <div class="font-bold text-blue-400 text-xl font-sans">${formatNum(p.currentPrice)}</div>
                            </div>
                            <button class="bg-green-600 text-white p-2 rounded-full shadow-lg hover:bg-green-500 add-check-btn">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-gray-400 mt-2 pt-2 border-t border-gray-700 font-sans">
                        <div class="flex justify-between"><span>6h Avg:</span> <span class="text-white">${formatNum(p.avg_6h)}</span></div>
                        <div class="flex justify-between"><span>Stability:</span> <span class="text-white">${p.cv ? (p.cv*100).toFixed(1)+'%' : '-'}</span></div>
                        <div class="flex justify-between"><span>12h Avg:</span> <span class="text-white">${formatNum(p.avg_12h)}</span></div>
                        <div class="flex justify-between"><span>Sell Zone:</span> <span class="text-white">${formatNum(p.sell_zone)}</span></div>
                        <div class="flex justify-between"><span>Median (10):</span> <span class="text-white">${formatNum(p.med10)}</span></div>
                        <div class="flex justify-between"><span>24h Low:</span> <span class="text-red-400 font-bold">${formatNum(p.low_24h)}</span></div>
                    </div>`;
                
                div.addEventListener('click', (e) => {
                    if(e.target.closest('.add-check-btn')) {
                        e.stopPropagation();
                        addToPortfolio(p.name, p.currentPrice);
                        showToast(`${p.name} added to Trades`);
                    } else {
                        if(p.link) window.open(p.link, '_blank');
                    }
                });
                
                resDiv.appendChild(div);
            });
            if(unique.length === 0) resDiv.innerHTML = `<div class="text-gray-500 p-2">No active players found.</div>`;
        });

        // --- TRACKER ---
        function saveTrades() {
            localStorage.setItem('fc_trades', JSON.stringify(state.trades));
            localStorage.setItem('fc_trade_history', JSON.stringify(state.history));
            renderTracker();
        }

        function addToPortfolio(name, buy) {
            state.trades.push({ id: Date.now(), name, buy, qty: 1 });
            saveTrades();
        }

        document.getElementById('trade-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('trade-name').value;
            const buy = cleanNum(document.getElementById('trade-buy').value);
            const qty = parseInt(document.getElementById('trade-qty').value);
            state.trades.push({ id: Date.now(), name, buy, qty });
            saveTrades();
            e.target.reset();
        });

        window.openSellModal = (id) => {
            const trade = state.trades.find(t => t.id == id);
            if (!trade) return;
            state.sellModalId = id;
            els.modalName.textContent = `Selling: ${trade.name}`;
            els.modalInput.value = '';
            els.modal.classList.remove('hidden');
            els.modalInput.focus();
        };

        els.modalConfirm.addEventListener('click', () => {
            const id = state.sellModalId;
            const sell = cleanNum(els.modalInput.value);
            if (sell > 0 && id) {
                const idx = state.trades.findIndex(t => t.id == id);
                if (idx > -1) {
                    const t = state.trades[idx];
                    const profit = Math.round((sell * 0.95 - t.buy) * t.qty);
                    state.history.push({ ...t, sell, profit, date: Date.now() });
                    state.trades.splice(idx, 1);
                    saveTrades();
                    els.modal.classList.add('hidden');
                }
            }
        });
        els.modalCancel.addEventListener('click', () => els.modal.classList.add('hidden'));

        window.triggerDelete = (id, type) => {
            state.deleteAction = () => {
                if(type === 'active') state.trades = state.trades.filter(t => t.id != id);
                else state.history = state.history.filter(t => t.id != id);
                saveTrades();
                els.confModal.classList.add('hidden');
            };
            els.confModal.classList.remove('hidden');
        };
        els.confOk.addEventListener('click', () => { if(state.deleteAction) state.deleteAction(); });
        els.confCancel.addEventListener('click', () => els.confModal.classList.add('hidden'));

        function renderTracker() {
            const activeBody = document.getElementById('active-trades-body');
            const histBody = document.getElementById('history-trades-body');
            activeBody.innerHTML = '';
            state.trades.forEach(t => {
                activeBody.innerHTML += `
                    <tr class="border-b border-[var(--bg-med)]">
                        <td class="px-4 py-2 text-white">${t.name}</td>
                        <td class="px-4 py-2 font-sans">${t.buy.toLocaleString()}</td>
                        <td class="px-4 py-2 font-sans">${t.qty}</td>
                        <td class="px-4 py-2 flex gap-2">
                            <button onclick="window.openSellModal(${t.id})" class="text-xs bg-green-600 text-white px-2 py-1 rounded">Sell</button>
                            <button onclick="window.triggerDelete(${t.id}, 'active')" class="text-xs bg-red-600 text-white px-2 py-1 rounded">X</button>
                        </td>
                    </tr>`;
            });
            document.getElementById('active-count').textContent = state.trades.length;
            document.getElementById('no-active-trades').classList.toggle('hidden', state.trades.length > 0);

            histBody.innerHTML = '';
            let tp = 0;
            state.history.sort((a,b) => b.date - a.date).forEach(t => {
                tp += t.profit;
                histBody.innerHTML += `
                    <tr class="border-b border-[var(--bg-med)]">
                        <td class="px-4 py-2 text-white">${t.name}</td>
                        <td class="px-4 py-2 font-sans">${t.buy.toLocaleString()}</td>
                        <td class="px-4 py-2 font-sans">${t.sell.toLocaleString()}</td>
                        <td class="px-4 py-2 font-bold font-sans ${t.profit >= 0 ? 'text-green-500' : 'text-red-500'}">${t.profit.toLocaleString()}</td>
                        <td class="px-4 py-2 flex justify-end"><button onclick="window.triggerDelete(${t.id}, 'history')" class="text-xs text-gray-500 hover:text-red-500 px-1">X</button></td>
                    </tr>`;
            });
            document.getElementById('total-profit-display').textContent = `TP: ${tp.toLocaleString()}`;
            document.getElementById('total-profit-display').className = `text-sm font-mono font-bold ${tp >= 0 ? 'text-green-400' : 'text-red-400'}`;
        }

        document.getElementById('tax-header').addEventListener('click', () => document.getElementById('tax-calc').classList.toggle('minimized'));
        ['calc-buy', 'calc-sell'].forEach(id => document.getElementById(id).addEventListener('input', () => {
            const buy = cleanNum(document.getElementById('calc-buy').value);
            const sell = cleanNum(document.getElementById('calc-sell').value);
            if(buy && sell) {
                const profit = Math.round(sell * 0.95 - buy);
                const res = document.getElementById('calc-result');
                res.textContent = profit.toLocaleString();
                res.className = `text-lg font-bold ${profit >= 0 ? 'text-green-500' : 'text-red-500'}`;
            }
        }));

        try {
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            
            onValue(ref(db, 'liveDeals'), (snap) => {
                const data = snap.val();
                if(data) {
                    state.deals = data;
                    document.getElementById('status-text').textContent = "Connected";
                    document.getElementById('status-indicator').classList.replace('bg-yellow-500', 'bg-green-500');
                    document.getElementById('status-indicator').classList.remove('animate-pulse');
                    render();
                }
            });
            
            onValue(ref(db, 'allPlayers'), (snap) => {
                const data = snap.val();
                if(data) state.allPlayers = data;
            });

            renderTracker(); renderDynamicFilters();
        } catch(e) { console.error(e); }

        ['input', 'change'].forEach(evt => Object.values(els.inputs).forEach(inp => inp.addEventListener(evt, (e) => {
            const id = e.target.id;
            if(id.includes('name')) state.filters.name = e.target.value;
            else if(id.includes('min-profit')) state.filters.minProfit = cleanNum(e.target.value);
            else if(id.includes('max-price')) state.filters.maxPrice = cleanNum(e.target.value);
            else if(id.includes('sort')) state.filters.sort = e.target.value;
            else if(id.includes('highlight')) state.filters.highlight = cleanNum(e.target.value);
            render();
        })));

    </script>
</body>
</html>
